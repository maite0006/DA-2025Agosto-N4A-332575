<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Emular tránsito</title>
  <link rel="stylesheet" href="css/menuAdministrador.css">
  
</head>

<body>
  <header class="topbar">
    <h1>Emular tránsito</h1>
  </header>

  <main class="container">
    <p class="descripcion">
      Seleccione un puesto, verifique sus tarifas, ingrese una matrícula y emule un tránsito.
    </p>

    <div class="grid-formulario">
      <section class="card formulario">
        <form id="formTransito" onsubmit="emularTransito(event)">
          <div class="form-group">
            <label for="puesto">Puesto</label>
            <select id="puesto" name="puesto" required>
              <option value="">Seleccione un puesto...</option>

            </select>
          </div>

          <div class="form-group">
            <label for="matricula">Matrícula</label>
            <input type="text" id="matricula" name="matricula" placeholder="EJ: ABC1234" required>
          </div>

          <div class="form-group">
            <label for="fechaHora">Fecha y hora del tránsito</label>
            <input type="datetime-local" id="fechaHora" name="fechaHora" required>
          </div>

          <button type="submit" class="btn-primario">Emular tránsito</button>
        </form>
        <div id="errorMsg" class="mensaje-error oculto"></div>
      </section>

      
      <section class="card tarifas">
        <h2>Tarifas del puesto</h2>
        <table>
          <thead>
            <tr><th>Categoría</th><th>Monto</th></tr>
          </thead>
          <tbody id="tablaTarifas">
            
          </tbody>
        </table>
        <p class="nota">Se muestran categoría y monto actuales del puesto seleccionado.</p>
      </section>
    </div>

    <!-- Resultado del tránsito -->
    <section class="card resultado">
      <h2>Resultado</h2>
      <div id="resultadoTransito">
        <p><strong>Propietario:</strong> Juan Pérez (Activo)</p>
        <p><strong>Categoría:</strong> A (Auto)</p>
        <p><strong>Bonificación:</strong> Residente Costa de Oro (10%)</p>
        <p><strong>Costo del tránsito:</strong> $ 120.00</p>
        <p><strong>Saldo luego del tránsito:</strong> $ 1400.75</p>
      </div>
    </section>

  </main>

  <footer>
    © 2025 — Emular tránsito
  </footer>

  <script src="utilesVista.js"></script>
  <script src="vistaWeb.js"></script>
</body>
  <script>
   const selectPuestos = document.getElementById("puesto"); 
    const tablaTarifasBody = document.getElementById("tablaTarifas");

    async function cargarPuestos() {
        try {
            const response = await fetch("/emularTransito/puestos");
            if (!response.ok) throw new Error("Error al obtener los puestos");
            const puestos = await response.json();

            // Llenar select
            puestos.forEach(p => {
                const option = document.createElement("option");
                option.value = p.nombre; 
                option.textContent = p.nombre+"-"+p.direccion;
                option.dataset.tarifas = JSON.stringify(p.tarifas); //  tarifas para usar luego
                selectPuestos.appendChild(option);
            });

        } catch (error) {
            console.error(error);
            alert("No se pudieron cargar los puestos");
        }
    }

    selectPuestos.addEventListener("change", function() {
        const selectedOption = selectPuestos.selectedOptions[0];
        const tarifas = JSON.parse(selectedOption.dataset.tarifas || "[]");

      
        tablaTarifasBody.innerHTML = "";

        // Renderizar tarifas
        tarifas.forEach(t => {
            const tr = document.createElement("tr");
            const tdCat = document.createElement("td");
            tdCat.textContent = t.categoria;
            const tdMonto = document.createElement("td");
            tdMonto.textContent = `$ ${t.monto.toFixed(2)}`;
            tr.appendChild(tdCat);
            tr.appendChild(tdMonto);
            tablaTarifasBody.appendChild(tr);
        });
    });

    function Logout() {
       submit('/accesoAdministrador/logout', '', 'POST'); 
    }
    

    function emularTransito(event) {
      event.preventDefault();
      limpiar_error(); 
      
      submit("/emularTrasito/emular", serializarFormulario("formBuscar"));
    }
    function mostrar_error(mensaje) {
      const div = document.getElementById("errorLocal");
      div.textContent = mensaje;
      div.classList.remove("oculto");
    }

    function limpiar_error() {
        const div = document.getElementById("errorLocal");
        div.textContent = "";
        div.classList.add("oculto");
    }

    function mostrar_logoutExitoso(urlDestino) {
        window.location.href = urlDestino;
    }

    function mostrar_usuarioNoAutenticado(urlDestino) {
        window.location.href = urlDestino;
    }
    cargarPuestos();
  </script>
</html>
