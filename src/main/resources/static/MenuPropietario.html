<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tablero de control del propietario</title>
  <link rel="stylesheet" href="css/menuPropietario.css">
  <script src='vistaWeb.js'></script>
  <script src='sse.js'></script>
</head>

<body>
  <script src="utilesVista.js"></script>
  <header class="topbar">
    <h1>Tablero de control del propietario</h1>
    <a href="#" onclick="logout()">Salir</a>
  </header>

  <main class="dashboard">

    <!-- Resumen propietario -->
    <section class="card resumen">
      <h2>Resumen del propietario</h2>
      <div class="resumen-grid">
        <div class="campo">
          <label>Nombre completo</label>
          <p id="nombrePropietario"></p>
        </div>
        <div class="campo">
          <label>Estado</label>
          <p id="estadoPropietario"></p>
        </div>
        <div class="campo">
          <label>Saldo actual</label>
          <p id="saldoPropietario"></p>
        </div>
      </div>
    </section>

    <!-- Bonificaciones y Vehículos -->
    <div class="grid-2">
      <section class="card">
        <h2>Bonificaciones asignadas</h2>
        <table>
          <thead>
            <tr><th>Bonificación</th><th>Puesto</th><th>Fecha asignada</th></tr>
          </thead>
          <tbody id="tablaBonificaciones">
           
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2>Vehículos registrados</h2>
        <table>
          <thead>
            <tr><th>Matrícula</th><th>Modelo</th><th>Color</th><th>Tránsitos</th><th>Monto total</th></tr>
          </thead>
          <tbody id="tablaVehiculos">
          
          </tbody>
        </table>
      </section>
    </div>

    <!-- Tránsitos realizados -->
    <section class="card">
      <h2>Tránsitos realizados</h2>
      <table>
        <thead>
          <tr>
            <th>Puesto</th><th>Matrícula</th><th>Categoría</th>
            <th>Monto tarifa</th><th>Bonificación</th>
            <th>Monto bonificación</th><th>Monto pagado</th>
            <th>Fecha</th><th>Hora</th>
          </tr>
        </thead>
        <tbody id="tablaTransitos">
          
              
        </tbody>
      </table>
    </section>

    <!-- Notificaciones -->
    <section class="card">
      <h2>Notificaciones del sistema</h2>
      <table>
        <thead><tr><th>Mensaje</th><th>Fecha</th></tr></thead>
        <tbody id="tablaNotificaciones">
          
        </tbody>
      </table>
      <button class="btn-borrar" onclick="borrarNotificaciones()">Borrar notificaciones</button>
    </section>
  </main>
  
  <script>
    urlIniciarVista="/menuprop/vistaConectada";
    urlRegistroSSE = "/menuprop/registrarSSE"; 

    function logout() { submit('/accesoPropietario/logout', null); }

    function borrarNotificaciones() { 
      submit("menuprop/borrarNotis","","DELETE")
     }
    function mostrar_notificacionM(mensaje){
      document.getElementById("tablaNotificaciones").innerHTML=""
      document.getElementById("tablaNotificaciones").innerHTML=mensaje;
    }
    
    function mostrar_logoutExitoso(urlDestino) {
        window.location.href = urlDestino;
    }

    function mostrar_propietario(p) {
        document.getElementById("nombrePropietario").innerHTML=p.nombre;
        document.getElementById("estadoPropietario").innerHTML=p.estado;
        document.getElementById("saldoPropietario").innerHTML=p.saldoA;
        
    }

    function mostrar_bonificaciones(bonificaciones){
         const tbody = document.getElementById("tablaBonificaciones");
        tbody.innerHTML = '';
         bonificaciones.forEach(b => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${b.nombre}</td>
                <td>${b.puesto}</td>
                <td>${b.fecha}</td>
            `;
            tbody.appendChild(tr);
          });
      }
      function mostrar_notificaciones(notificaciones) {
        const tbody = document.getElementById("tablaNotificaciones");
        tbody.innerHTML = '';
        notificaciones.forEach(noti => {
          const fecha = new Date(noti.fechaHora);
          const fechaStr = fecha.toLocaleString();
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${noti.mensaje}</td><td>${fechaStr}</td>`;
          tbody.appendChild(tr);
        });
      }
      function mostrar_vehiculos(vehiculos) {
            const tbody = document.getElementById("tablaVehiculos");
          tbody.innerHTML = '';

          vehiculos.forEach(v => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${v.matricula}</td>
                <td>${v.modelo}</td>
                <td>${v.color}</td>
                <td>${v.transitos}</td>
                <td>${v.totalT}</td>
            `;
            tbody.appendChild(tr);
          });
      }
    
    function mostrar_transitos(transitos) {
        const tbody = document.getElementById("tablaTransitos");
        tbody.innerHTML = '';

        transitos.forEach(t => {
            const { fecha, hora } = separarFechaHora(t.fechaHora);
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${t.puesto}</td>
            <td>${t.matricula}</td>
            <td>${t.categoria}</td>
            <td>${t.tarifa}$</td>
            <td>${t.bonificacion}</td>
            <td>-${t.descuento}$</td>
            <td>${t.totalF}$</td>
            <td>${fecha}</td>
            <td>${hora}</td>
            `;
            tbody.appendChild(tr);
        });
    }
    function separarFechaHora(fechaStr) {
        const [fecha, hora] = fechaStr.split("T");
        return { fecha, hora };
    }
  

    function procesarMensajeSSE(mensaje) {
        procesarResultadosSubmit(mensaje); 
    }
    function conexionSSECerrada(event){
            cerrar();
    }
    async function cerrar(){
            let respuesta = await mostrarConfirmacion("Se ha cerrado la aplicacion en esta ventana", "Intenar volver a abrirla", "Cerrar");
        if (respuesta) {
            window.location.href = "/LoginProp.html"
        } else {
            document.body.innerHTML = '';
            window.location.href = "/LoginProp.html"
        }
    }
  </script>
  
  
</body>

</html>
